# 多用户Agent开发和使用系统 - 需求分析

## 1. 项目概述

### 1.1 项目背景

基于现有MaaS（Model-as-a-Service）平台，构建一个多用户Agent开发和使用系统。该系统允许开发者创建和发布智能Agent到AgentStore，用户可以发现、配置和使用这些Agent进行多轮对话。

### 1.2 系统目标

- 为开发者提供完整的Agent开发、测试、发布平台
- 为用户提供丰富的Agent商店和便捷的使用体验
- 支持Agent与大模型、MCP工具、RAG系统的深度集成
- 实现多用户、多Agent、多对话的并发管理

## 2. 用户角色分析

### 2.1 Developer（开发者）

**主要职责：**
- 开发和调试Agent逻辑
- 配置Agent参数和工具集成
- 发布Agent到AgentStore
- 管理Agent版本和更新

**核心需求：**
- 可视化Agent开发环境
- 代码编辑和调试工具
- 测试环境和沙箱执行
- 版本控制和发布管理
- 使用统计和反馈分析

### 2.2 User（最终用户）

**主要职责：**
- 浏览和搜索AgentStore中的Agent
- 配置个人API密钥和参数
- 与Agent进行多轮对话
- 管理对话历史和会话

**核心需求：**
- Agent发现和搜索功能
- 个人配置管理界面
- 直观的对话交互界面
- 多会话并行管理
- 对话历史查看和导出

## 3. 功能需求详细分析

### 3.1 Agent开发平台需求

**核心功能：**
- 代码编辑器：支持Python、JavaScript等语言的Agent开发
- 调试工具：断点调试、日志查看、变量监控
- 测试环境：沙箱环境中测试Agent功能
- **工作流模板系统**：提供标准化的工作流模板和节点类型
- **模板管理器**：模板创建、编辑、验证和发布工具
- **节点类型定义**：标准化节点类型，支持输入输出Schema验证
- 版本管理：Git风格的版本控制和分支管理

**工作流设计需求：**
- **双模式支持**：既支持基于模板的快速开发，也支持自定义内联工作流
- **可视化编辑器**：拖拽式工作流设计界面，支持节点配置和连线
- **模板参数化**：支持模板参数动态配置和实例化
- **节点验证**：实时验证节点配置是否符合类型要求
- **边类型支持**：支持普通边、条件边和扇出边三种LangGraph边类型

**技术要求：**
- 基于Web的IDE环境
- LangGraph工作流可视化编辑
- LangChain工具链集成
- 安全的代码执行沙箱
- **JSON Schema验证**：节点输入输出和模板参数验证
- **模板引擎**：支持工作流模板的实例化和参数替换

### 3.2 AgentStore商店系统需求

**核心功能：**
- 发布管理：Agent提交、审核、发布流程
- 分类体系：按功能、行业、技术栈分类
- 搜索推荐：基于关键词、标签、评分的智能搜索
- 评价系统：用户评分、评论、使用统计
- 版本管理：Agent更新通知和版本兼容性

### 3.3 多对话管理系统需求

**核心功能：**
- 会话创建：用户可为同一Agent创建多个独立会话
- 并发对话：支持用户同时与多个Agent对话
- 上下文管理：每个会话维护独立的对话历史和上下文
- 消息持久化：所有对话消息安全存储
- 实时通信：WebSocket支持实时消息推送

**核心数据关系：**
- User 1:N Chat (用户可创建多个对话)
- Agent 1:N Chat (Agent可被多个用户使用)
- Agent 1:N AgentVersion (Agent有多个版本)
- Chat N:1 AgentVersion (对话锁定特定Agent版本)
- Chat 1:N ChatMessage (对话包含多条消息)
- ChatMessage 1:N ChatMessage (消息支持回复树结构)
- Chat 1:N WorkflowExecution (对话可触发多次工作流执行)
- WorkflowExecution 1:N WorkflowNodeExecution (工作流执行包含多个节点执行)
- WorkflowExecution 1:N HumanInterventionTask (工作流可能需要人工干预)
- User N:M Agent (through AgentUsage，用户使用Agent的记录)

### 3.4 配置管理系统需求

**核心功能：**
- API密钥管理：安全存储和管理各种API密钥
- 模型配置：用户可选择和配置大模型参数
- 工具配置：MCP工具的个性化配置
- 偏好设置：界面主题、通知设置等个人偏好

**安全要求：**
- API密钥加密存储（国密SM4算法）
- 细粒度权限控制
- 审计日志记录

### 3.5 MCP工具集成需求（基于FastMCP Client-Server架构）

**核心功能：**
- **工具CRUD管理**：客户端负责工具的创建、更新、删除和查询
- **工具实现执行**：服务端负责工具的具体功能实现和执行
- **Topic服务器管理**：支持多租户工具隔离和动态管理
- **HTTP Streaming通信**：双向流式通信支持长时间任务和实时进度
- **权限控制**：用户授权Agent使用特定工具
- **工具商店**：第三方工具的发现和安装

**技术架构：**
- **Client-Server分离设计**：基于FastMCP框架的分离式架构
- **HTTP Streaming协议**：替代传统SSE，支持HTTP/2多路复用
- **Topic级别隔离**：每个Agent版本对应独立的Topic服务器
- **连接池优化**：高性能连接管理和批量操作支持
- **工具沙箱执行环境**：独立的MCP服务器确保安全隔离
- **异步工具调用机制**：支持并发工具调用和流式响应

### 3.6 RAG知识集成需求

**核心功能：**
- 知识库管理：用户可上传和管理知识文档
- 向量化处理：文档自动向量化和索引
- 知识检索：Agent运行时智能检索相关知识
- 知识更新：支持知识库的增量更新

**技术选型：**
- Milvus向量数据库
- 多种文档格式支持
- 智能分块和向量化

## 4. 数据结构需求分析

### 4.1 Agent相关数据结构

#### 4.1.1 Agent分类表结构

```
AgentCategory {
  id: UUID (主键)
  name: string (分类名称，最大100字符)
  parent_id: UUID (父分类引用，支持层级分类)
  description: TEXT (分类描述)
  created_at: TIMESTAMP (创建时间)
}
```

#### 4.1.2 Agent主表结构

基于数据库表结构设计，Agent数据模型应包含：

```
Agent {
  id: UUID (主键)
  name: string (Agent名称，最大255字符)
  description: TEXT (Agent详细描述)
  developer_id: UUID (开发者用户引用)
  category_id: UUID (Agent分类引用)
  tags: string[] (Agent标签数组，支持动态标签)
  status: string (状态：draft/published/archived，默认draft)
  download_count: integer (下载次数统计，默认0)
  average_rating: decimal(3,2) (平均评分，精度到小数点后2位)
  published_at: TIMESTAMP (发布时间)
  created_at: TIMESTAMP (创建时间)
  updated_at: TIMESTAMP (更新时间)
}
```

#### 4.1.3 Agent使用记录表结构

```
AgentUsage {
  id: UUID (主键)
  user_id: UUID (用户引用)
  agent_id: UUID (Agent引用)
  first_used_at: TIMESTAMP (首次使用时间)
  last_used_at: TIMESTAMP (最后使用时间)
  usage_count: integer (使用次数统计，默认1)
  // 约束：(user_id, agent_id) 唯一
}
```

### 4.2 Agent版本数据结构

支持Multi-Agent工作流和模板系统的版本管理：

```
AgentVersion {
  id: UUID (主键)
  agent_id: UUID (Agent引用，级联删除)
  version: string (版本号，最大50字符)
  
  // 🚀 基于节点的服务依赖配置（支持Multi-Agent工作流）
  service_dependencies: JSONB (服务依赖配置，默认{})
  /*
  格式示例：
  Multi-Agent: {
    "code_analyzer": {"llm_service": 20, "database_service": 8},
    "security_reviewer": {"llm_service": 15, "database_service": 12}, 
    "performance_checker": {"llm_service": 25, "database_service": 15, "vector_db": 18},
    "web_researcher": {"search_service": 23, "llm_service": 16}
  }
  单Agent: {"main_agent": {"llm_service": 15, "search_service": 23, "vector_db": 12}}
  */
  
  model_params_override: JSONB (可选的模型参数覆盖)
  
  // 🎯 工作流定义方式（二选一）
  workflow_definition: JSONB (自定义工作流逻辑，内联方式)
  workflow_template_id: UUID (工作流模板引用，基于模板方式)
  template_parameters: JSONB (模板参数实例化值)
  
  system_prompt: TEXT (系统提示词)
  tool_dependencies: TEXT[] (工具依赖列表，默认空数组)
  
  rag_enabled: BOOLEAN (RAG功能开关，默认false，v2.0支持)
  
  // 版本管理
  changelog: TEXT (版本变更说明)
  is_current: BOOLEAN (标识当前使用版本，默认false)
  created_at: TIMESTAMP (创建时间)
  
  // 约束：
  // 1. workflow_definition和workflow_template_id二选一
  // 2. 每个agent_id只能有一个is_current=true的版本
}
```

### 4.2.1 工作流模板相关数据结构

#### 节点类型定义表结构

```
NodeType {
  id: UUID (主键)
  type_name: string (节点类型名称，唯一，如：llm_processor)
  display_name: string (显示名称)
  description: TEXT (类型描述)
  
  // 验证和配置
  input_schema: JSONB (输入参数JSON Schema)
  output_schema: JSONB (输出参数JSON Schema)
  required_services: TEXT[] (必需的服务类型)
  default_config: JSONB (默认配置)
  
  // 分类和标签
  category: string (分类：processing/io/control/integration)
  tags: TEXT[] (标签)
  
  is_active: BOOLEAN (是否启用，默认true)
  created_at: TIMESTAMP (创建时间)
  updated_at: TIMESTAMP (更新时间)
}
```

#### 工作流模板表结构

```
WorkflowTemplate {
  id: UUID (主键)
  name: string (模板名称，最大255字符)
  display_name: string (模板显示名称)
  description: TEXT (模板描述)
  category: string (分类：代码审查/内容生成/数据分析等)
  
  // 模板定义
  template_definition: JSONB (标准化的workflow结构)
  parameter_schema: JSONB (参数化配置schema)
  
  // 使用统计
  usage_count: integer (使用次数，默认0)
  average_rating: decimal(3,2) (平均评分)
  
  // 版本和状态
  version: string (版本号，默认1.0.0)
  status: string (状态：active/deprecated/draft)
  
  created_by: UUID (创建者引用)
  created_at: TIMESTAMP (创建时间)
  updated_at: TIMESTAMP (更新时间)
}
```

#### 模板节点定义表结构

```
WorkflowTemplateNode {
  id: UUID (主键)
  template_id: UUID (模板引用，级联删除)
  node_name: string (节点名称，最大128字符)
  node_type_id: UUID (节点类型引用)
  
  // 节点配置
  node_config: JSONB (节点具体配置)
  position_config: JSONB (UI位置信息)
  
  // 关系定义
  parent_nodes: TEXT[] (父节点列表)
  child_nodes: TEXT[] (子节点列表)
  
  created_at: TIMESTAMP (创建时间)
  
  // 约束：(template_id, node_name) 唯一
}
```

#### 模板边定义表结构

```
WorkflowTemplateEdge {
  id: UUID (主键)
  template_id: UUID (模板引用，级联删除)
  
  // 边的基本信息
  from_node: string (源节点名称)
  to_node: string (目标节点名称，NULL表示动态目标)
  edge_type: string (边类型：normal/conditional/fanout)
  
  // 条件边配置
  condition_function: TEXT (条件函数名或表达式)
  condition_mapping: JSONB (条件到目标的映射)
  
  // 扇出边配置
  fanout_targets: TEXT[] (并行执行的目标节点列表)
  fanout_condition: JSONB (扇出条件逻辑)
  
  // 执行策略
  execution_order: integer (执行顺序，默认0)
  timeout_seconds: integer (超时时间)
  retry_policy: JSONB (重试策略)
  
  created_at: TIMESTAMP (创建时间)
}
```

### 4.3 对话相关数据结构

#### 4.3.1 聊天会话表结构（版本锁定优化版）

```
Chat {
  id: UUID (主键)
  user_id: UUID (用户引用)
  agent_id: UUID (Agent引用)
  agent_version_id: UUID (Agent版本锁定引用) // 🎯 关键：锁定使用的Agent版本
  title: string (对话标题，最大255字符)
  context: JSONB (对话上下文)
  status: string (状态：active/archived/deleted，默认active)
  expires_at: TIMESTAMP (过期时间)
  created_at: TIMESTAMP (创建时间)
  updated_at: TIMESTAMP (更新时间)
}
```

#### 4.3.2 聊天消息表结构（集成LangGraph工作流支持）

```
ChatMessage {
  id: UUID (主键)
  chat_id: UUID (对话引用)
  parent_message_id: UUID (父消息引用，支持消息树结构)
  role: string (角色：user/assistant，最大50字符)
  content: TEXT (消息内容)
  status: string (状态：sending/sent/failed/deleted，默认sent)
  metadata: JSONB (消息元数据)
  
  // 🚀 LangGraph工作流集成字段
  workflow_execution_id: UUID (关联工作流执行ID)
  workflow_node_name: string (产生此消息的工作流节点，最大128字符)
  workflow_status: string (工作流状态：running/completed/failed/paused，默认completed)
  message_type: string (消息类型：text/progress/error/system，默认text)
  is_intermediate: BOOLEAN (是否为中间进度消息，可清理，默认false)
  
  created_at: TIMESTAMP (创建时间)
}
```

#### 4.3.3 工作流执行跟踪表结构（LangGraph集成支持）

```
WorkflowExecution {
  execution_id: UUID (主键)
  chat_id: UUID (对话引用，级联删除)
  message_id: UUID (触发消息引用，级联删除)
  agent_version_id: UUID (Agent版本引用，必填)
  
  // LangGraph检查点集成
  thread_id: string (对应LangGraph的thread_id格式：chat_{chat_id}，最大255字符)
  checkpoint_id: string (当前检查点ID，最大255字符)
  checkpointer_schema: string (PostgreSQL schema名称，默认'langgraph'，最大64字符)
  
  // 执行状态
  status: string (状态：running/completed/failed/paused/interrupted，默认running)
  current_node: string (当前执行的工作流节点，最大128字符)
  
  // 执行结果和错误
  final_result: JSONB (最终执行结果)
  error_info: JSONB (错误详细信息)
  
  // 性能统计
  total_nodes: integer (总节点数，默认0)
  completed_nodes: integer (已完成节点数，默认0)
  failed_nodes: integer (失败节点数，默认0)
  
  // 时间戳
  started_at: TIMESTAMP (开始时间)
  completed_at: TIMESTAMP (完成时间)
  paused_at: TIMESTAMP (暂停时间，人工干预)
  
  // 约束：(chat_id, thread_id) 唯一
}
```

#### 4.3.4 工作流节点执行记录表结构

```
WorkflowNodeExecution {
  id: UUID (主键)
  execution_id: UUID (工作流执行引用，级联删除)
  node_name: string (节点名称，最大128字符)
  
  // 执行状态
  status: string (状态：running/completed/failed/skipped，默认running)
  
  // 执行数据
  input_state: JSONB (节点输入状态)
  output_state: JSONB (节点输出状态)
  service_calls: JSONB (服务调用记录详情)
  
  // 性能信息
  started_at: TIMESTAMP (开始时间)
  completed_at: TIMESTAMP (完成时间)
  duration_ms: integer (执行耗时毫秒)
  
  // 重试和错误处理
  retry_count: integer (重试次数，默认0)
  max_retries: integer (最大重试次数，默认3)
  error_message: TEXT (错误信息)
  
  // 资源消耗统计
  tokens_consumed: integer (LLM token消耗)
  cost_estimate: decimal(10,6) (预估成本)
}
```

#### 4.3.5 人工干预任务表结构（支持LangGraph人机协作）

```
HumanInterventionTask {
  task_id: UUID (主键)
  execution_id: UUID (工作流执行引用，级联删除)
  node_name: string (节点名称，最大128字符)
  
  // 任务信息
  instruction: TEXT (给人工的指导说明)
  current_state: JSONB (当前工作流状态)
  required_input_schema: JSONB (期望的人工输入格式)
  
  // 任务状态
  status: string (状态：pending/in_progress/completed/cancelled，默认pending)
  assigned_to: string (分配给谁处理，最大128字符)
  
  // 处理结果
  human_input: JSONB (人工提供的输入)
  completion_note: TEXT (完成说明)
  
  // 时间戳
  created_at: TIMESTAMP (创建时间)
  assigned_at: TIMESTAMP (分配时间)
  completed_at: TIMESTAMP (完成时间)
  
  // 优先级和截止时间
  priority: integer (优先级1-10，数字越大优先级越高，默认5)
  due_at: TIMESTAMP (期望完成时间)
}
```

### 4.4 统一服务配置数据结构

```
Provider {
  provider_id: INTEGER (主键)
  provider_name: string (供应商名称)
  display_name: string (显示名称)
  service_type: string (服务类型：llm/search/database等)
  description: TEXT (描述)
  base_url: string (基础URL)
  is_active: BOOLEAN (启用状态)
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

ServiceConfig {
  config_id: INTEGER (主键)
  provider_id: INTEGER (供应商引用)
  service_name: string (服务名称)
  service_display_name: string (服务显示名称)
  service_type: string (服务类型)
  config_data: JSONB (配置数据)
  credentials: TEXT (加密认证信息)
  pricing_config: JSONB (定价配置)
  limits_config: JSONB (使用限制配置)
  is_active: BOOLEAN (启用状态)
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}
```

### 4.5 MCP工具相关数据结构

```
MCPTool {
  id: UUID (主键)
  name: string (工具名称)
  version: string (工具版本)
  description: TEXT (工具描述)
  tool_type: string (工具类型：http_api/code_tool/database/system)
  manifest: JSONB (工具接口清单和配置)
  server_endpoint: string (MCP服务器端点)
  topic_server_id: string (所属Topic服务器ID)
  status: string (状态：active/inactive/deprecated)
  tags: TEXT[] (工具标签数组)
  is_streaming_supported: BOOLEAN (流式调用支持)
  max_execution_time: INTEGER (最大执行时间)
  resource_requirements: JSONB (资源需求配置)
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

MCPTopicServer {
  id: UUID (主键)
  server_id: string (Topic服务器标识)
  name: string (服务器名称)
  description: TEXT (描述信息)
  agent_version_id: UUID (关联Agent版本)
  endpoint_url: string (MCP服务器端点)
  status: string (状态：active/inactive/error)
  tool_count: INTEGER (注册工具数量)
  total_calls: INTEGER (总调用次数)
  success_calls: INTEGER (成功调用次数)
  average_response_time: DECIMAL (平均响应时间)
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
  last_health_check: TIMESTAMP (最后健康检查时间)
}
```

## 5. 非功能性需求

### 5.1 性能需求

- **并发对话支持**：支持单用户同时进行多个Agent对话
- **响应时间**：Agent响应时间控制在5秒内
- **系统吞吐量**：支持1000+并发用户
- **数据库性能**：复杂查询响应时间<500ms

### 5.2 安全需求

- **数据加密**：API密钥使用国密SM4算法加密存储
- **权限控制**：基于RBAC的细粒度权限管理
- **沙箱执行**：Agent代码在安全沙箱环境中执行
- **审计日志**：完整的操作审计记录

### 5.3 可用性需求

- **系统可用性**：99.9%系统可用性
- **故障恢复**：支持故障快速恢复和数据备份
- **负载均衡**：支持水平扩展和负载分发

### 5.4 兼容性需求

- **浏览器兼容**：支持Chrome、Firefox、Safari等主流浏览器
- **移动端适配**：响应式设计，支持移动端访问
- **API兼容**：与现有MaaS系统API保持兼容

## 6. 约束条件

### 6.1 技术约束

- 必须基于现有MaaS系统的DDD架构
- 使用Python 3.11+和FastAPI框架
- 数据库使用PostgreSQL
- 前端使用Vue 3 + TypeScript

### 6.2 业务约束

- Agent必须经过审核才能发布到商店
- 用户对话数据必须安全存储并符合隐私规定
- 系统必须支持多语言（中文优先）

### 6.3 时间约束

- 系统开发周期：6个月
- 分阶段交付，每个阶段4-6周
- 必须在现有系统基础上渐进式开发

## 7. 验收标准

### 7.1 功能验收标准

- **Agent开发平台**：开发者可以完整创建、测试、发布Agent
- **AgentStore商店**：用户可以搜索、安装、评价Agent
- **多对话系统**：用户可以同时与多个Agent进行对话
- **配置管理**：用户零配置即可使用Agent（平台统一管理API密钥）

### 7.2 性能验收标准

- 支持1000+并发用户同时使用
- Agent响应时间<5秒
- 系统可用性>99.9%
- 数据库查询响应时间<500ms

### 7.3 安全验收标准

- API密钥100%加密存储
- 所有用户操作有完整审计日志
- Agent代码在安全沙箱中执行
- 通过安全渗透测试

## 8. 风险评估

### 8.1 技术风险

- **LangGraph集成复杂度**：工作流状态管理和错误处理复杂
- **多Agent并发性能**：大量并发对话可能影响系统性能
- **MCP工具安全性**：第三方工具执行存在安全隐患

### 8.2 业务风险

- **用户接受度**：新的Agent概念需要用户学习成本
- **内容质量控制**：Agent质量参差不齐影响用户体验
- **成本控制**：大模型调用成本需要有效控制

### 8.3 缓解策略

- 建立原型验证关键技术点
- 实施渐进式功能发布策略
- 建立完善的监控和告警机制
- 制定详细的测试计划和质量标准